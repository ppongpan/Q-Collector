# v0.7.18 Debug Testing Guide - 401 Error Investigation

**Date:** 2025-10-12
**Status:** üîç Ready for Testing
**Version:** 0.7.18-dev

---

## Summary

This document provides testing instructions for investigating the **401 Unauthorized error** when loading images via the `/files/{id}/stream` endpoint.

### What Was Done

1. ‚úÖ **v0.7.18 useRef Flickering Fix**: Completed (images no longer flicker when toast appears)
2. ‚úÖ **Debug Logging Added**: Extensive console logging to diagnose 401 error
3. ‚úÖ **Compilation Success**: Frontend compiled with warnings only (no errors)
4. ‚úÖ **Servers Running**: Both frontend (localhost:3000) and backend (localhost:5000) running

### Current Issue

When viewing submission details, images fail to load with:
```
GET http://localhost:3000/api/v1/files/d6c803b0-347f-49fe-b7b7-7ce5315ad1e4/stream 401 (Unauthorized)
```

**Note:** Other API calls work fine with proper authentication, only the image stream endpoint fails.

---

## Testing Instructions

### Step 1: Clear Browser Cache

**Important:** Clear your browser cache and hard reload to ensure you're running the latest code.

1. Open Chrome DevTools (F12)
2. Right-click the refresh button
3. Click "Empty Cache and Hard Reload"

### Step 2: Open Console

1. Open Chrome DevTools (F12)
2. Navigate to "Console" tab
3. Clear existing logs (click trash icon)

### Step 3: Navigate to Submission Detail

1. Login to the application
2. Navigate to a form with submissions
3. Click on a submission that has image fields
4. Wait for the page to load

### Step 4: Check Console Output

Look for these debug messages in the console:

#### Expected Debug Messages:

**1. Image Authentication Check:**
```javascript
üîê [SubmissionDetail] Image auth check: {
  hasToken: true/false,
  tokenKey: "q-collector-auth-token",
  tokenLength: 123,
  filesCount: 1
}
```

**2. Token Missing Alert (if no token):**
```javascript
‚ùå [SubmissionDetail] NO TOKEN found in localStorage! {
  storageKey: "q-collector-auth-token",
  allKeys: ["key1", "key2", ...]
}
```

**3. Image Fetch Request:**
```javascript
üñºÔ∏è [SubmissionDetail] Fetching image stream: {
  fileId: "d6c803b0-347f-49fe-b7b7-7ce5315ad1e4",
  streamUrl: "http://localhost:3000/api/v1/files/.../stream",
  hasToken: true,
  tokenPreview: "eyJhbGciOiJIUzI1NiIs..."
}
```

**4. Success Message:**
```javascript
‚úÖ [SubmissionDetail] Image loaded successfully: d6c803b0-347f-49fe-b7b7-7ce5315ad1e4
```

**5. Error Message (if fails):**
```javascript
‚ùå [SubmissionDetail] Failed to load image d6c803b0-...: 401 Unauthorized
```

---

## What to Report

Please copy and paste **ALL** console output and send it to me. Specifically, I need:

### Critical Information:

1. **Token Status**:
   - Does `hasToken: true` or `hasToken: false`?
   - What is the `tokenKey` value?
   - What is the `tokenLength`?

2. **Token Storage**:
   - If NO TOKEN message appears, what keys are in `allKeys`?
   - Is there a similar key with a different name?

3. **Fetch Request**:
   - What is the `streamUrl`?
   - Does `hasToken: true` in the fetch log?
   - What does `tokenPreview` show (first 20 characters)?

4. **Response Status**:
   - Does it show success (‚úÖ) or error (‚ùå)?
   - If error, what is the exact error message?

---

## Expected Scenarios

### Scenario 1: Token Not Found

**Console Output:**
```
‚ùå [SubmissionDetail] NO TOKEN found in localStorage!
```

**Diagnosis:** Token is missing from localStorage (wrong storage key)

**Fix:** Update `API_CONFIG.token.storageKey` to match actual key

---

### Scenario 2: Token Found But 401 Still Occurs

**Console Output:**
```
üîê hasToken: true
üñºÔ∏è hasToken: true, tokenPreview: "eyJhbGci..."
‚ùå Failed to load image: 401 Unauthorized
```

**Diagnosis:** Token is present and being sent, but backend rejects it

**Possible Causes:**
- Token expired
- Backend `/files/:id/stream` endpoint requires different authentication
- CORS or proxy stripping Authorization header
- Token format issue

---

### Scenario 3: Token Format Issue

**Console Output:**
```
üîê hasToken: true, tokenLength: 5
```

**Diagnosis:** Token is too short (likely corrupted or wrong value)

**Fix:** Check if correct token is being stored

---

## Additional Debug Steps

If console logs don't provide enough information, please also:

1. **Check Network Tab**:
   - Open Chrome DevTools ‚Üí Network tab
   - Filter by "stream"
   - Click on the failed request
   - Go to "Headers" tab
   - Check if "Authorization" header is present
   - Copy the exact request headers

2. **Check localStorage**:
   - Open Chrome DevTools ‚Üí Application tab
   - Go to "Local Storage" ‚Üí "http://localhost:3000"
   - Look for keys containing "token" or "auth"
   - Take a screenshot

3. **Check Backend Logs**:
   - Look at backend console output
   - Search for logs related to `/files/.../stream` endpoint
   - Copy any error messages

---

## Backend Debug Logging

The backend is also logging detailed information. If needed, check the backend console for:

- `CORS: Origin http://localhost:5000/ - ALLOWED`
- `GET /api/v1/files/xxx/stream` status code
- Any authentication errors

---

## Next Steps

Once you provide the console output, I will:

1. **Analyze Token Status**: Determine if token is present and correct
2. **Identify Root Cause**: Pinpoint why 401 is occurring
3. **Implement Fix**: Apply appropriate solution based on diagnosis
4. **Test Verification**: Confirm fix resolves the issue

---

## Files Modified (v0.7.18)

### `src/components/SubmissionDetail.jsx`

**Lines 676-735**: Added comprehensive debug logging

**Debug Features:**
- Token presence check with storage key
- Token length validation
- All localStorage keys dump (if token missing)
- Per-file fetch request logging
- Success/failure status for each image
- Token preview (first 20 chars) for verification

**Code Changes:**
```javascript
// Lines 676-689: Token authentication check
const token = localStorage.getItem(API_CONFIG.token.storageKey);

console.log('üîê [SubmissionDetail] Image auth check:', {
  hasToken: !!token,
  tokenKey: API_CONFIG.token.storageKey,
  tokenLength: token?.length,
  filesCount: files?.length
});

if (!token) {
  console.error('‚ùå [SubmissionDetail] NO TOKEN found in localStorage!', {
    storageKey: API_CONFIG.token.storageKey,
    allKeys: Object.keys(localStorage)
  });
}

// Lines 706-714: Fetch request logging
console.log('üñºÔ∏è [SubmissionDetail] Fetching image stream:', {
  fileId: file.id,
  streamUrl,
  hasToken: !!token,
  tokenPreview: token?.substring(0, 20) + '...'
});

const response = await fetch(streamUrl, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

// Lines 716-725: Response logging
if (response.ok) {
  console.log('‚úÖ [SubmissionDetail] Image loaded successfully:', file.id);
} else {
  console.error(`‚ùå [SubmissionDetail] Failed to load image ${file.id}: ${response.status} ${response.statusText}`);
}
```

---

## Compilation Status

```
‚úÖ Frontend: Compiled successfully with warnings (no errors)
‚úÖ Backend: Running on localhost:5000
‚úÖ Frontend: Running on localhost:3000
‚ö†Ô∏è Warnings: Unused imports only (non-blocking)
```

---

## Summary

**Completed Work:**
- ‚úÖ v0.7.18 useRef flickering fix (images stable during toast)
- ‚úÖ Debug logging system (comprehensive token/fetch tracking)
- ‚úÖ Compilation success (both servers running)

**Current Task:**
- üîç Investigate 401 Unauthorized error with debug logs
- üìã Waiting for user test results and console output

**What I Need From You:**
- Complete console output after following testing instructions
- Network tab headers (if available)
- localStorage screenshot (if needed)

Once you provide the console logs, I can quickly identify the root cause and implement the appropriate fix! üéØ
