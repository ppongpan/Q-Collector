# Q-Collector Sub-Form Testing Guide

**Version:** 0.7.2-dev
**Date:** 2025-10-05

Complete guide for testing form creation with sub-forms

---

## üéØ Overview

This guide provides step-by-step instructions for testing Q-Collector's sub-form functionality, including both manual and automated testing approaches.

---

## ‚öôÔ∏è Pre-Test Setup

### 1. System Requirements

**Running Services:**
```bash
‚úÖ Backend (Port 5000) - Running
‚úÖ Frontend (Port 3000) - Running
‚úÖ PostgreSQL - Online
‚úÖ Redis - Online
‚úÖ MinIO - Online
```

**Check Status:**
```bash
# Backend
netstat -ano | findstr :5000

# Frontend
netstat -ano | findstr :3000

# Docker services
docker ps
```

### 2. Test User Configuration

**Default Test User:** `pongpanp` / `Gfvtmiu613`

**‚ö†Ô∏è Important: 2FA Consideration**

If 2FA is enabled for test user:

**Option A: Manual OTP Entry (Current)**
- Test will pause for 30 seconds
- Enter OTP from Authenticator app manually
- Test continues automatically

**Option B: Disable 2FA for Testing**
```sql
-- Connect to PostgreSQL
psql -h localhost -p 5432 -U qcollector_dev -d qcollector_dev

-- Disable 2FA for test user
UPDATE users
SET two_factor_enabled = false,
    two_factor_secret = NULL,
    requires_2fa_setup = false
WHERE username = 'pongpanp';
```

**Option C: Use Backup Codes**
- Keep backup codes handy
- Automate OTP entry with backup code

---

## üìù Manual Testing Workflow

### Test Case 1: Create Form with Sub-Forms

#### Step 1: Navigate to Form Builder
1. Login at http://localhost:3000
2. Click **"‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà"** button
3. Wait for form builder to load

#### Step 2: Set Main Form Details
1. **Form Title**: Click text "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°..."
   - Type: `‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Sub-Form`
   - Press **Enter**

2. **Form Description**: Click text "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ü‡∏≠‡∏£‡πå‡∏°..."
   - Type: `‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° Sub-Form`
   - Press **Enter**

#### Step 3: Add Main Form Fields

**Field 1: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•**
1. Click **"‡∏ü‡∏¥‡∏•‡∏î‡πå"** tab (if not active)
2. Click **"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå"** button
3. Select field type: **"‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô"**
4. Click on field card header to **expand**
5. In **"‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå"** input, type: `‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•`
6. In **"Placeholder"** input, type: `‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`
7. Click field card header to **collapse**
8. Click toggle icons:
   - üî¥ **Required** (red !)
   - üîµ **Show in Table** (blue table) - enabled after required
   - üü¢ **Telegram** (green chat)

**Field 2: ‡∏≠‡∏µ‡πÄ‡∏°‡∏•**
1. Click **"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå"**
2. Select: **"‡∏≠‡∏µ‡πÄ‡∏°‡∏•"**
3. Expand ‚Üí Type title: `‡∏≠‡∏µ‡πÄ‡∏°‡∏•`
4. Collapse ‚Üí Toggle: üî¥ Required, üîµ Table

**Field 3: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå**
1. Click **"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå"**
2. Select: **"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"**
3. Expand ‚Üí Type title: `‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå`
4. Collapse ‚Üí Toggle: üî¥ Required

#### Step 4: Add Sub-Forms

**Navigate to Sub-Forms Tab**
1. Click **"‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡πà‡∏≠‡∏¢"** tab

**Sub-Form 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà**
1. Click **"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡πà‡∏≠‡∏¢"** button
2. Click SubForm title ‚Üí Type: `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà`
3. Click SubForm description ‚Üí Type: `‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠`
4. Add fields in SubForm:
   - **Field 1**: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß ‚Üí `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà`
   - **Field 2**: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î`
   - **Field 3**: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‚Üí `‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠`

**Sub-Form 2: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö**
1. Click **"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡πà‡∏≠‡∏¢"**
2. Title: `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö`
3. Description: `‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö`
4. Add fields:
   - **Field 1**: ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå ‚Üí `‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£`
   - **Field 2**: ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ ‚Üí `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö`

#### Step 5: Save Form
1. Click **"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°"** button
2. Wait for success message: **"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"**
3. Verify form appears in form list

#### Step 6: Verify Database

**Check via API:**
```bash
# Get forms list
curl http://localhost:5000/api/v1/forms \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Check via PostgreSQL:**
```sql
-- Get latest form
SELECT id, title, created_at
FROM forms
ORDER BY created_at DESC
LIMIT 1;

-- Count main fields
SELECT COUNT(*) as main_fields
FROM fields
WHERE form_id = 'YOUR_FORM_ID'
  AND sub_form_id IS NULL;

-- Count sub-forms
SELECT COUNT(*) as sub_forms
FROM sub_forms
WHERE form_id = 'YOUR_FORM_ID';

-- Count sub-form fields
SELECT sf.title, COUNT(f.id) as field_count
FROM sub_forms sf
LEFT JOIN fields f ON f.sub_form_id = sf.id
WHERE sf.form_id = 'YOUR_FORM_ID'
GROUP BY sf.id, sf.title;
```

---

### Test Case 2: Sub-Form Management

**Test Actions:**
1. **Move Up/Down**: Click ‚ãÆ menu ‚Üí "‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô" / "‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á"
2. **Duplicate**: Click ‚ãÆ menu ‚Üí "‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤" ‚Üí Verify copy exists
3. **Delete**: Click ‚ãÆ menu ‚Üí "‡∏•‡∏ö" ‚Üí Verify deletion

**Expected Results:**
- Order changes correctly
- Duplicated sub-form has " (‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)" suffix
- Deleted sub-form disappears

---

### Test Case 3: Field Toggle Icons

**Test Sequence:**
1. Add field ‚Üí Collapse
2. Click üî¥ Required ‚Üí Should activate (red background + dot)
3. Click üîµ Table ‚Üí Should activate (only if required=true)
4. Click üü¢ Telegram ‚Üí Should activate
5. Click üî¥ Required again ‚Üí All toggles reset (cascade effect)

**Validation:**
- Required toggle: Red background when active
- Table toggle: Blue background, disabled when required=false
- Telegram toggle: Green background
- Maximum 5 fields can show in table

---

## ü§ñ Automated Testing

### Run E2E Tests

**Full Test Suite:**
```bash
npx playwright test tests/e2e/form-with-subform-creation.spec.js --headed --workers=1
```

**Specific Test:**
```bash
# Complete form creation
npx playwright test tests/e2e/form-with-subform-creation.spec.js:101 --headed

# Sub-form management
npx playwright test tests/e2e/form-with-subform-creation.spec.js:374 --headed

# Toggle icons
npx playwright test tests/e2e/form-with-subform-creation.spec.js:433 --headed
```

**With 2FA Manual Entry:**
```bash
# Test will pause 30 seconds for OTP entry
npx playwright test tests/e2e/form-with-subform-creation.spec.js --headed --workers=1
```

**View Test Report:**
```bash
npx playwright show-report
```

---

## üìä Test Coverage

### Test Scenarios Covered

‚úÖ **Form Creation**
- Main form title/description (InlineEdit)
- Adding 17 field types
- Field expansion/collapse
- Field settings persistence

‚úÖ **Sub-Form Creation**
- Add multiple sub-forms
- Sub-form title/description
- Add fields to sub-forms
- Sub-form field ordering

‚úÖ **Toggle Icons**
- Required toggle activation
- Table toggle (dependency on required)
- Telegram toggle
- Cascade effect (uncheck required)
- Maximum table fields limit (5)

‚úÖ **Sub-Form Management**
- Move up/down
- Duplicate sub-form
- Delete sub-form
- Drag & drop ordering

‚úÖ **Database Verification**
- Form record created
- Main fields saved correctly
- Sub-forms saved with relationships
- Field settings persisted

---

## üîç Common Issues & Solutions

### Issue 1: 2FA Blocking Tests

**Symptom:**
```
TimeoutError: page.waitForSelector: Timeout 15000ms exceeded.
Waiting for: text=/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà|‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°/i
```

**Solution:**
1. Enter OTP manually within 30 seconds
2. Or disable 2FA for test user (see setup section)
3. Or use Playwright authentication state persistence

---

### Issue 2: Toggle Icon Not Clickable

**Symptom:** Table toggle doesn't activate

**Cause:** Field not required

**Solution:**
1. Always click Required toggle first
2. Wait 300ms before clicking Table toggle

**Code:**
```javascript
await toggleFieldIcon(page, fieldCard, '‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô');
await page.waitForTimeout(300);
await toggleFieldIcon(page, fieldCard, '‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á');
```

---

### Issue 3: Field Card Not Expanding

**Symptom:** Click doesn't expand field

**Cause:** Clicking on toggle icon area

**Solution:** Click on left side of card header
```javascript
await fieldCard.click({ position: { x: 100, y: 20 } });
```

---

### Issue 4: InlineEdit Not Saving

**Symptom:** Text changes don't persist

**Cause:** Blur event not triggered

**Solution:** Press Enter explicitly
```javascript
await page.click(selector);
await page.keyboard.type('New Value');
await page.keyboard.press('Enter'); // Important!
await page.waitForTimeout(500);
```

---

## üìà Expected Test Results

### Successful Test Run

```
‚úì Complete Form Creation Flow with Sub-Forms (25s)
  üìù Step 1: Navigate to Form Builder
  üìù Step 2: Set Main Form Title
  üìù Step 3: Set Form Description
  üìù Step 4: Add Main Form Fields
    ‚ûï Adding field: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    ‚ûï Adding field: ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    ‚ûï Adding field: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
  üìù Step 5: Add Sub-Forms
    ‚ûï Adding SubForm 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
    ‚ûï Adding SubForm 2: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
  üìù Step 6: Save Form
  ‚úÖ Form saved successfully!
  üìù Step 7: Verify Form in Database
  ‚úÖ All verifications passed!
  üìä Test Summary: {
    mainFields: 3,
    subForms: 2,
    totalSubFormFields: 5
  }

‚úì Sub-Form Management: Move, Duplicate, Delete (12s)
  üìù Testing: Duplicate SubForm
  ‚úÖ SubForm duplicated successfully
  üìù Testing: Move SubForm Up
  ‚úÖ SubForm moved up
  üìù Testing: Delete SubForm
  ‚úÖ SubForm deleted successfully

‚úì Field Toggle Icons: Required ‚Üí Table ‚Üí Telegram (8s)
  üìù Testing: Required Toggle
  ‚úÖ Required toggle activated
  üìù Testing: Table Toggle
  ‚úÖ Table toggle activated
  üìù Testing: Telegram Toggle
  ‚úÖ Telegram toggle activated
  üìù Testing: Uncheck Required (cascade)
  ‚úÖ Cascade uncheck works correctly

3 passed (45s)
```

---

## üé¨ Test Execution Commands

### Quick Commands

```bash
# Start servers (if not running)
npm start         # Backend (separate terminal)
npm run dev       # Frontend (separate terminal)

# Run all sub-form tests
npx playwright test form-with-subform-creation --headed

# Run with UI mode (interactive)
npx playwright test --ui

# Debug specific test
npx playwright test form-with-subform-creation:101 --debug

# Generate test report
npx playwright test && npx playwright show-report
```

### Environment Setup

```bash
# Backend
cd backend
npm start

# Frontend
npm run dev

# Verify services
curl http://localhost:5000/health
curl http://localhost:3000
```

---

## üìö Related Files

- **Test Script**: `tests/e2e/form-with-subform-creation.spec.js`
- **UI Guide**: `docs/UI-INTERACTION-GUIDE.md`
- **Main Component**: `src/components/EnhancedFormBuilder.jsx`
- **Toggle Icons**: `src/components/ui/field-toggle-buttons.jsx`
- **Sub-Form Builder**: `src/components/EnhancedFormBuilder.jsx:704-1010`

---

## üéØ Next Steps

### After Successful Testing

1. **Update CLAUDE.md** with test results
2. **Document any new bugs** in GitHub issues
3. **Optimize slow selectors** if needed
4. **Add more test cases** for edge cases
5. **Setup CI/CD pipeline** for automated testing

### Future Enhancements

- [ ] Playwright authentication state persistence
- [ ] Visual regression testing
- [ ] API contract testing
- [ ] Performance testing (form with 50+ fields)
- [ ] Accessibility testing

---

**Last Updated:** 2025-10-05
**Q-Collector Version:** 0.7.2-dev
